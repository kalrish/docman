---
AWSTemplateFormatVersion: 2010-09-09


Description: Document storage and management.


Parameters:

   BucketName:
      Description: Name of the S3 bucket.
      Type: String
      Default: djsp-documents

   RoleName:
      Description: Name of the IAM role.
      Type: String
      Default: documents-manager

   TrusteeArn:
      Description: ARN of the trustee.
      Type: String
      Default: arn:aws:iam::659664769788:user/david


Resources:

   Bucket:
      Type: AWS::S3::Bucket
      Properties: {
         BucketEncryption: {
            ServerSideEncryptionConfiguration: [
               {
                  ServerSideEncryptionByDefault: {
                     SSEAlgorithm: AES256,
                  },
               },
            ],
         },
         BucketName: {
            Ref: BucketName,
         },
         PublicAccessBlockConfiguration: {
            BlockPublicAcls: true,
            BlockPublicPolicy: true,
            IgnorePublicAcls: true,
            RestrictPublicBuckets: true,
         },
      }

   BucketPolicy:
      Type: AWS::S3::BucketPolicy
      Properties: {
         Bucket: {
            Ref: Bucket,
         },
         PolicyDocument: {
            Version: 2012-10-17,
            Statement: [
               {
                  Sid: EnforceTagging,
                  Principal: '*',
                  Action: [
                     's3:PutObject',
                     's3:PutObjectTagging',
                  ],
                  Resource: [
                     {
                        'Fn::Sub': '${Bucket.Arn}/*',
                     },
                  ],
                  Condition: {
                     StringNotLike: {
                        'aws:userId': [
                           {
                              'Fn::Sub': '${DocumentsManager.RoleId}:*',
                           },
                        ],
                     },
                  },
                  Effect: Deny,
               },
               {
                  Sid: RestrictObjectStorageClasses,
                  Principal: '*',
                  Action: [
                     's3:PutObject',
                  ],
                  Resource: [
                     {
                        'Fn::Sub': '${Bucket.Arn}/*',
                     },
                  ],
                  Condition: {
                     StringNotEquals: {
                        's3:x-amz-storage-class': [
                           STANDARD,
                           STANDARD_IA,
                        ],
                     },
                  },
                  Effect: Deny,
               },
               {
                  Sid: PreventDamage,
                  Principal: '*',
                  Action: [
                     's3:DeleteObject',
                     's3:DeleteObjectTagging',
                     's3:DeleteObjectVersion',
                     's3:DeleteObjectVersionTagging',
                  ],
                  Resource: [
                     {
                        'Fn::GetAtt': [
                           Bucket,
                           Arn,
                        ],
                     },
                     {
                        'Fn::Sub': '${Bucket.Arn}/*',
                     },
                  ],
                  Effect: Deny,
               },
            ],
         },
      }

   DocumentsManager:
      Type: AWS::IAM::Role
      Properties: {
         AssumeRolePolicyDocument: {
            Version: 2012-10-17,
            Statement: [
               {
                  Principal: {
                     AWS: [
                        {
                           Ref: TrusteeArn,
                        },
                     ],
                  },
                  Action: [
                     'sts:AssumeRole',
                  ],
                  Effect: Allow,
               },
            ],
         },
         Description: {
            'Fn::Sub': 'Manages documents in bucket ${Bucket}.',
         },
         Policies: [
            {
               PolicyName: read,
               PolicyDocument: {
                  Version: 2012-10-17,
                  Statement: [
                     {
                        Sid: Bucket,
                        Action: [
                           's3:ListBucket',
                        ],
                        Resource: [
                           {
                              'Fn::GetAtt': [
                                 Bucket,
                                 Arn,
                              ],
                           },
                        ],
                        Effect: Allow,
                     },
                     {
                        Sid: Objects,
                        Action: [
                           's3:GetObject',
                           's3:GetObjectTagging',
                        ],
                        Resource: [
                           {
                              'Fn::Sub': '${Bucket.Arn}/*'
                           },
                        ],
                        Effect: Allow,
                     },
                  ],
               },
            },
            {
               PolicyName: write,
               PolicyDocument: {
                  Version: 2012-10-17,
                  Statement: [
                     {
                        Sid: Arbeitgeberbescheinigungen,
                        Action: [
                           's3:PutObject',
                           's3:PutObjectTagging',
                        ],
                        Resource: [
                           {
                              'Fn::Sub': '${Bucket.Arn}/Arbeitgeberbescheinigungen/20??-??-??.pdf'
                           },
                        ],
                        Condition: {
                           'ForAllValues:StringLike': {
                              's3:RequestObjectTagKeys': [
                                 Arbeitgeber,
                                 years,
                              ],
                           },
                           StringEquals: {
                              's3:RequestObjectTag/Arbeitgeber': [
                                 Smaato,
                              ],
                           },
                           StringLike: {
                              's3:RequestObjectTag/years': [
                                 '20??',
                              ],
                           },
                        },
                        Effect: Allow,
                     },
                     {
                        Sid: Depotauszuege,
                        Action: [
                           's3:PutObject',
                           's3:PutObjectTagging',
                        ],
                        Resource: [
                           {
                              'Fn::Sub': '${Bucket.Arn}/Depotauszüge/?????????/20??-??-??.pdf'
                           },
                        ],
                        Condition: {
                           'ForAllValues:StringLike': {
                              's3:RequestObjectTagKeys': [
                                 Bank,
                                 date,
                                 years,
                              ],
                           },
                           StringEquals: {
                              's3:RequestObjectTag/Bank': [
                                 DKB,
                              ],
                           },
                           StringLike: {
                              's3:RequestObjectTag/date': [
                                 '20??.??.??',
                              ],
                              's3:RequestObjectTag/years': [
                                 '20??',
                              ],
                           },
                        },
                        Effect: Allow,
                     },
                     {
                        Sid: Entgeltaufstellungen,
                        Action: [
                           's3:PutObject',
                           's3:PutObjectTagging',
                        ],
                        Resource: [
                           {
                              'Fn::Sub': '${Bucket.Arn}/Entgeltaufstellungen/??????????/20??.pdf'
                           },
                        ],
                        Condition: {
                           'ForAllValues:StringLike': {
                              's3:RequestObjectTagKeys': [
                                 Bank,
                                 years,
                              ],
                           },
                           StringEquals: {
                              's3:RequestObjectTag/Bank': [
                                 DKB,
                              ],
                           },
                           StringLike: {
                              's3:RequestObjectTag/years': [
                                 '20??',
                              ],
                           },
                        },
                        Effect: Allow,
                     },
                     {
                        Sid: Gehaltsabrechnungen,
                        Action: [
                           's3:PutObject',
                           's3:PutObjectTagging',
                        ],
                        Resource: [
                           {
                              'Fn::Sub': '${Bucket.Arn}/Gehaltsabrechnungen/20??/??.pdf'
                           },
                        ],
                        Condition: {
                           'ForAllValues:StringLike': {
                              's3:RequestObjectTagKeys': [
                                 Arbeitgeber,
                                 years,
                              ],
                           },
                           StringEquals: {
                              's3:RequestObjectTag/Arbeitgeber': [
                                 Smaato,
                              ],
                           },
                           StringLike: {
                              's3:RequestObjectTag/years': [
                                 '20??',
                              ],
                           },
                        },
                        Effect: Allow,
                     },
                     {
                        Sid: Kontoauszuege,
                        Action: [
                           's3:PutObject',
                           's3:PutObjectTagging',
                        ],
                        Resource: [
                           {
                              'Fn::Sub': '${Bucket.Arn}/Kontoauszüge/??????????/20??-??-??_20??-??-??.pdf'
                           },
                        ],
                        Condition: {
                           'ForAllValues:StringLike': {
                              's3:RequestObjectTagKeys': [
                                 Bank,
                                 years,
                              ],
                           },
                           StringEquals: {
                              's3:RequestObjectTag/Bank': [
                                 DKB,
                              ],
                           },
                           StringLike: {
                              's3:RequestObjectTag/years': [
                                 '20??',
                                 '20?? 20??',
                              ],
                           },
                        },
                        Effect: Allow,
                     },
                     {
                        Sid: Kreditkartenabrechnungen,
                        Action: [
                           's3:PutObject',
                           's3:PutObjectTagging',
                        ],
                        Resource: [
                           {
                              'Fn::Sub': '${Bucket.Arn}/Kreditkartenabrechnungen/*/20??-??-??_20??-??-??.pdf'
                           },
                        ],
                        Condition: {
                           'ForAllValues:StringLike': {
                              's3:RequestObjectTagKeys': [
                                 Bank,
                                 years,
                              ],
                           },
                           StringEquals: {
                              's3:RequestObjectTag/Bank': [
                                 DKB,
                              ],
                           },
                           StringLike: {
                              's3:RequestObjectTag/years': [
                                 '20??',
                                 '20?? 20??',
                              ],
                           },
                        },
                        Effect: Allow,
                     },
                     {
                        Sid: Lohnsteuerbescheinigungen,
                        Action: [
                           's3:PutObject',
                           's3:PutObjectTagging',
                        ],
                        Resource: [
                           {
                              'Fn::Sub': '${Bucket.Arn}/Lohnsteuerbescheinigungen/20??.pdf'
                           },
                        ],
                        Condition: {
                           'ForAllValues:StringLike': {
                              's3:RequestObjectTagKeys': [
                                 Arbeitgeber,
                                 years,
                              ],
                           },
                           StringEquals: {
                              's3:RequestObjectTag/Arbeitgeber': [
                                 Smaato,
                              ],
                           },
                           StringLike: {
                              's3:RequestObjectTag/years': [
                                 '20??',
                              ],
                           },
                        },
                        Effect: Allow,
                     },
                     {
                        Sid: Meldebestaetigungen,
                        Action: [
                           's3:PutObject',
                           's3:PutObjectTagging',
                        ],
                        Resource: [
                           {
                              'Fn::Sub': '${Bucket.Arn}/Meldebestätigungen/*.pdf'
                           },
                        ],
                        Condition: {
                           'ForAllValues:StringLike': {
                              's3:RequestObjectTagKeys': [
                                 PLZ,
                                 years,
                              ],
                           },
                           StringLike: {
                              's3:RequestObjectTag/PLZ': [
                                 '?????',
                              ],
                              's3:RequestObjectTag/years': [
                                 '20??',
                              ],
                           },
                        },
                        Effect: Allow,
                     },
                     {
                        Sid: Rechnungen,
                        Action: [
                           's3:PutObject',
                           's3:PutObjectTagging',
                        ],
                        Resource: [
                           {
                              'Fn::Sub': '${Bucket.Arn}/Rechnungen/*/*.pdf'
                           },
                        ],
                        Condition: {
                           'ForAllValues:StringLike': {
                              's3:RequestObjectTagKeys': [
                                 date,
                                 deductable,
                                 years,
                              ],
                           },
                           StringEquals: {
                              's3:RequestObjectTag/deductable': [
                                 'no',
                                 'yes',
                              ],
                           },
                           StringLike: {
                              's3:RequestObjectTag/date': [
                                 '20??.??.??',
                              ],
                              's3:RequestObjectTag/years': [
                                 '20??',
                              ],
                           },
                        },
                        Effect: Allow,
                     },
                     {
                        Sid: SCHUFADatenkopien,
                        Action: [
                           's3:PutObject',
                           's3:PutObjectTagging',
                        ],
                        Resource: [
                           {
                              'Fn::Sub': '${Bucket.Arn}/SCHUFA/Datenkopien/20??-??-??.zip'
                           },
                           {
                              'Fn::Sub': '${Bucket.Arn}/SCHUFA/Datenkopien/20??-??-??/??.jpeg'
                           },
                        ],
                        Condition: {
                           'ForAllValues:StringLike': {
                              's3:RequestObjectTagKeys': [
                                 date,
                                 years,
                              ],
                           },
                           StringLike: {
                              's3:RequestObjectTag/date': [
                                 '20??.??.??',
                              ],
                              's3:RequestObjectTag/years': [
                                 '20??',
                              ],
                           },
                        },
                        Effect: Allow,
                     },
                     {
                        Sid: Sozialversicherung,
                        Action: [
                           's3:PutObject',
                           's3:PutObjectTagging',
                        ],
                        Resource: [
                           {
                              'Fn::Sub': '${Bucket.Arn}/Sozialversicherung/20??-??-??.pdf'
                           },
                        ],
                        Condition: {
                           'ForAllValues:StringLike': {
                              's3:RequestObjectTagKeys': [
                                 date,
                                 Grund,
                                 years,
                              ],
                           },
                           StringEquals: {
                              's3:RequestObjectTag/Grund': [
                                 Anmeldung,
                                 Jahresmeldung,
                              ],
                           },
                           StringLike: {
                              's3:RequestObjectTag/date': [
                                 '20??.??.??',
                              ],
                              's3:RequestObjectTag/years': [
                                 '20??',
                              ],
                           },
                        },
                        Effect: Allow,
                     },
                     {
                        Sid: Steuerbescheide,
                        Action: [
                           's3:PutObject',
                           's3:PutObjectTagging',
                        ],
                        Resource: [
                           {
                              'Fn::Sub': '${Bucket.Arn}/Steuerbescheide/20??.pdf'
                           },
                        ],
                        Condition: {
                           'ForAllValues:StringLike': {
                              's3:RequestObjectTagKeys': [
                                 years,
                              ],
                           },
                           StringLike: {
                              's3:RequestObjectTag/years': [
                                 '20??',
                              ],
                           },
                        },
                        Effect: Allow,
                     },
                     {
                        Sid: Zuzahlungsquittungen,
                        Action: [
                           's3:PutObject',
                           's3:PutObjectTagging',
                        ],
                        Resource: [
                           {
                              'Fn::Sub': '${Bucket.Arn}/Zuzahlungsquittungen/20??-??-??.pdf'
                           },
                        ],
                        Condition: {
                           'ForAllValues:StringLike': {
                              's3:RequestObjectTagKeys': [
                                 date,
                                 deductable,
                                 years,
                              ],
                           },
                           StringEquals: {
                              's3:RequestObjectTag/deductable': [
                                 'yes',
                              ],
                           },
                           StringLike: {
                              's3:RequestObjectTag/date': [
                                 '20??.??.??',
                              ],
                              's3:RequestObjectTag/years': [
                                 '20??',
                              ],
                           },
                        },
                        Effect: Allow,
                     },
                     {
                        Sid: Wertpapierabrechnungen,
                        Action: [
                           's3:PutObject',
                           's3:PutObjectTagging',
                        ],
                        Resource: [
                           {
                              'Fn::Sub': '${Bucket.Arn}/Wertpapierabrechnungen/?????????/*.pdf'
                           },
                        ],
                        Condition: {
                           'ForAllValues:StringLike': {
                              's3:RequestObjectTagKeys': [
                                 date,
                                 Bank,
                                 ISIN,
                                 Umsatzart,
                                 years,
                              ],
                           },
                           StringEquals: {
                              's3:RequestObjectTag/Bank': [
                                 DKB,
                              ],
                              's3:RequestObjectTag/Umsatzart': [
                                 Kauf,
                                 Verkauf,
                              ],
                           },
                           StringLike: {
                              's3:RequestObjectTag/date': [
                                 '20??.??.??',
                              ],
                              's3:RequestObjectTag/ISIN': [
                                 'DE??????????',
                                 'FR??????????',
                                 'LU??????????',
                                 'US??????????',
                              ],
                              's3:RequestObjectTag/years': [
                                 '20??',
                              ],
                           },
                        },
                        Effect: Allow,
                     },
                  ],
               },
            },
         ],
         RoleName: {
            Ref: RoleName,
         },
      }
